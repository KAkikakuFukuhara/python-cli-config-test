# README

　このリポジトリは、自分のプログラムで`--help`オプションを付けた際に非常に遅い問題の解決に取り組むために作成した。  

- [1. はじめに](#1-はじめに)
  - [1.1. 問題と原因](#11-問題と原因)
  - [1.2. 解決策](#12-解決策)
- [2. 実験用プログラムの作成と実行例](#2-実験用プログラムの作成と実行例)

## 1. はじめに
### 1.1. 問題と原因

 　具体的には、コマンドライン解析ツール(`argparse`)を使用したプログラムを実行した際に`--help`オプションでヘルプを表示しようとすると、ヘルプが表示されるまでに時間がかかる現象が起きた。少数のオプションではあまり問題にならないが、オプションの数が増えると必然的に`--help`コマンドを多用するので多発してしまうと困る。  
　原因は、コマンドラインの解析の際に同時に重たいライブラリを import していることであった（例えば`pytorch`や`tensorflow`）。巨大かつC++ライブラリを読み込む処理がヘルプコマンドを実行する際に毎回読み込まれているのである。  

### 1.2. 解決策
 　解決策として、実行部とコマンドラインインターフェース(以下CLI)を切り分けることである。これによりコマンドライン解析時点では必要なライブラリがimportされず後回しにされるため、速度問題の解消となる。  

## 2. 実験用プログラムの作成と実行例

 　重たい import を以下のように`time.sleep`を用いて擬似的に再現したライブラリ([./cli_config_test/lib/testlib.py](./cli_config_test/lib/testlib.py))を作成する。  
```python
import time

print("start import 'cli_config_test.test_lib'... ")
time.sleep(5)
print("done")
```
 　これをimportするプログラムを作成して、CLIを追加した呼び出しプログラムを作成する。そしてその後にCLI部分のみ切り分けて、切り分けたCLI部を読み出して実際の呼び出しプログラムを実行するプログラムを作成する。これは言ってしまえば、呼び出しプログラムの呼び出しプログラムである（適当に二重呼び出しプログラムと本稿では定義することにする）。  

以下の２つのプログラムで比較する.
```bash
python cli_config_test/tools/test1_1.py --help
python cli_config_test/tools/test1_2.py --help
```

 　１つめのプログラムは呼び出しプログラムである。そして２つめのプログラムは二重呼び出しプログラムである。両者を比較してあからさまに２つめのプログラムの方が早いことが分かるだろう。  

 　前述した内容でCLI部分を切り分けることで`--help`オプションが早くなることが分かった。しかし、全てのプログラムに二重呼び出しプログラムを追加する必要がある。それはファイル数が増えるのであまり好ましくなく、また命名にも困るので一つのプログラムにまとめることにする。  
 　まとめたプログラムは `./cli_config_test/__main__.py`として作成した。まとめ方は'subparser'という機能を用いてるが、詳細はココでは記載しない。以下のように用いて使うことができる。  
```bash
python cli_config_test test1 --help
python cli_config_test test2 --help
```
